---
title: "Statistics in Action - case study 1"
author: "Sebastien Moeller"
output:
  html_document:
    fig_height: 3
    fig_width: 8
    number_sections: no
    toc: no
  pdf_document:
    fig_height: 3
    fig_width: 8
    includes:
      before_body: macros.tex
    keep_tex: yes
    number_sections: no
    toc: no
---

```{r}
if (!require("pacman")) install.packages("pacman")

pacman::p_load(tidyverse, ggplot2)
```

# Introduction

The dataset <ttt>dataMON810_2018.csv</ttt> consists of several measurements made during a subchronic toxicity study concerning the MON810 maize.

Biochemical parameters reflecting most physiological functions were measured two times (week 5 and 14), in particular through serum and urine chemistry, and hematology. Organ weights were measured at week 14.

The main objective of this study is to evaluate possible GMO effects on these parameters.

# Single comparison

#### __(Q1)__ 
We consider the variable "CALCIUM".
```{r}
data <- read.csv('dataMON810_2018.csv')
```

###### a. Test if the mean level of calcium for period 2 is the same for males and females.  </br>**Hint:** plot first the data and justify the test(s) to use.
```{r}
# Filter the data was want and remove NA from variable
calciumA <- data %>% filter(period == 2) %>% select(CALCIUM, sex) %>% na.omit

# Calculate the sample means
calciumAMean <- aggregate(calciumA$CALCIUM  ~ calciumA$sex, FUN = 'mean')
colnames(calciumAMean) <- c('sex', 'CALCIUM')

# Plot the data
ggplot() + 
  geom_point(data = calciumA, aes(x = CALCIUM, y = sex, colour = sex, alpha = 0.5), show.legend = FALSE) +
  geom_point(data = calciumAMean, aes(x = CALCIUM, y = sex, color = sex, size = 4, alpha = 0.5), show.legend = FALSE)

# Let's take a look at the means
calciumAMean
```

Looking at the data we see that the `$CALCIUM$` means between male and female are close. Computing a p-value here is of interest to see if they are significantly different.

The hypotheses we are testing are as follow:
$$
H_0:\mu_{x} = \mu_{y} \space\text{ versus }\space H_1:\mu_{x} \neq\mu_{y}
$$

###### Assuming equal variances
We can use the function `t.test`. Let $x$ and $y$ denote $males$ and $females$ respectively.

Assuming first equal variances $(\sigma^2_x = \sigma^2_y)$. We select a 5% significance level and run the test.
```{r}
alpha <- 0.05
t.test((calciumA %>% filter(sex == 'M'))$CALCIUM, (calciumA %>% filter(sex == 'F'))$CALCIUM, conf.level = 1 - alpha, var.equal = TRUE)
```

Under the assumption that the two sexes have equal variances, we find a low `p-value < 2.2e-16` and thus __reject the null _hypothesis__ that $\mu_x = \mu_y$.

###### F-test for equal variances
As stated, the previous t-test assumed that the two populations have equal variances. An F-test is used to test if the variances of two populations are equal. We will perform a two tailed test to see if our previous assumption was valid or incorrect.

For the F-test, our hypotheses are as follow:
$H_0: \sigma_x = \sigma_y \space\text{versus}\space H_1:\sigma_x \neq \sigma_y$
```{r}
var.test((calciumA %>% filter(sex == 'M'))$CALCIUM, (calciumA %>% filter(sex == 'F'))$CALCIUM, conf.level = 1 - alpha, alternative = 'two.sided')
```

Our intuition was correct, the true ratio of variances $\frac{\sigma_x}{\sigma_y} \neq 1$. Thus we __reject the null hypothesis__.

###### Assuming different variances
Assuming equal variances between the two groups has been disputed.
```{r}
aggregate(calciumA$CALCIUM  ~ calciumA$sex, FUN = 'sd')
```

The sample data of size 97 for males and 90 for females have very different standard deviations. It is therefore important to run the t-test without the assumption of equal variances.
```{r}
t.test((calciumA %>% filter(sex == 'M'))$CALCIUM, (calciumA %>% filter(sex == 'F'))$CALCIUM, conf.level = 1 - alpha, var.equal = FALSE)
```

Our new t-test also __rejects the null hypothesis__ that the two groups share the same mean displaying a `p-value = 3.455e-15`.

###### Conclusion
We can safely conclude that the two sexes do indeed have different means by the means of a t-test without equal variances.

##### b. Test for the males if the mean level of calcium is the same for period 1 and period 2.
```{r}
# Filter the data was want and remove NA from variable
calciumB <- data %>% filter(sex == 'M') %>% select(period, CALCIUM) %>% na.omit
calciumB$period <- as.factor(calciumB$period)

calciumBMean <- aggregate(calciumB$CALCIUM  ~ calciumB$period, FUN = 'mean')
colnames(calciumBMean) <- c('period', 'CALCIUM')

# Plot the data
ggplot() + 
  geom_point(data = calciumB, aes(x = CALCIUM, y = period, colour = period, alpha = 0.5), show.legend = FALSE) +
  geom_point(data = calciumBMean, aes(x = CALCIUM, y = period, color = period, size = 4, alpha = 0.5), show.legend = FALSE)

# Let's take a look at the means
calciumBMean
```

###### F-test for equal variances
As stated, the previous t-test assumed that the two populations have equal variances. An F-test is used to test if the variances of two populations are equal. We will perform a two tailed test to see if our previous assumption was valid or incorrect.

For the F-test, our hypotheses are as follow:
$H_0: \sigma_x = \sigma_y \space\text{versus}\space H_1:\sigma_x \neq \sigma_y$
```{r}
var.test((calciumB %>% filter(period == 1))$CALCIUM, (calciumB %>% filter(period == 2))$CALCIUM, conf.level = 1 - alpha, alternative = 'two.sided')
```

Our intuition was correct, the true ratio of variances $\frac{\sigma_x}{\sigma_y} \neq 1$. Thus we __reject the null hypothesis__.

###### Assuming different variances
Assuming equal variances between the two groups has been disputed.
```{r}
aggregate(calciumB$CALCIUM  ~ calciumB$period, FUN = 'sd')
```

```{r}
dim(filter(calciumB, period == 1))[1]
dim(filter(calciumB, period == 2))[1]
```


The sample data of size 98 for period 1 males, and 97 for period 2 males have very different standard deviations. It is therefore important to run the t-test without the assumption of equal variances.
```{r}
t.test((calciumB %>% filter(period == 1))$CALCIUM, (calciumB %>% filter(period == 2))$CALCIUM, conf.level = 1 - alpha, var.equal = FALSE)
```

Our new t-test also __rejects the null hypothesis__ that the two groups share the same mean displaying a `p-value = 3.113e-10`.

###### Conclusion
We can safely conclude that the male population between the two periods do indeed have different means.

##### c. Test for the males if the mean level of calcium for period 2 is the same for the control group and the MON810 group.
```{r}
# Filter the data was want and remove NA from variable
calciumC <- data %>% filter(sex == 'M') %>% filter(period == 2) %>% select(regimen, CALCIUM) %>% filter(regimen %in% c('MON810', 'control')) %>% na.omit
calciumC$regimen <- as.factor(calciumC$regimen)

calciumCMean <- aggregate(calciumC$CALCIUM  ~ calciumC$regimen, FUN = 'mean')
colnames(calciumCMean) <- c('regimen', 'CALCIUM')

# Plot the data
ggplot() + 
  geom_point(data = calciumC, aes(x = CALCIUM, y = regimen, colour = regimen, alpha = 0.5), show.legend = FALSE) +
  geom_point(data = calciumCMean, aes(x = CALCIUM, y = regimen, color = regimen, size = 4, alpha = 0.5), show.legend = FALSE)

# Let's take a look at the means
calciumCMean
```

###### F-test for equal variances
As stated, the previous t-test assumed that the two populations have equal variances. An F-test is used to test if the variances of two populations are equal. We will perform a two tailed test to see if our previous assumption was valid or incorrect.

For the F-test, our hypotheses are as follow:
$H_0: \sigma_x = \sigma_y \space\text{versus}\space H_1:\sigma_x \neq \sigma_y$
```{r}
var.test((calciumC %>% filter(regimen == 'control'))$CALCIUM, (calciumC %>% filter(regimen == 'MON810'))$CALCIUM, conf.level = 1 - alpha, alternative = 'two.sided')
```

Our F-test returns a `p-value = 0.03762` and thus __rejects the nullhypothesis__ that $\frac{\sigma_x}{\sigma_y} = 1$ at a 5% two tailed confidence level.

###### Assuming different variances
Assuming equal variances between the two groups has been disputed.
```{r}
aggregate(calciumC$CALCIUM  ~ calciumC$regimen, FUN = 'sd')
```

```{r}
dim(filter(calciumC, regimen == 'control'))[1]
dim(filter(calciumC, regimen == 'MON810'))[1]
```


Out control set consists of 20 observations and the MON810 consists of 19 observations and have different standard deviations. It is therefore important to run the t-test without the assumption of equal variances.
```{r}
t.test((calciumC %>% filter(regimen == 'control'))$CALCIUM, (calciumC %>% filter(regimen == 'MON810'))$CALCIUM, conf.level = 1 - alpha, var.equal = FALSE)
```

Our new t-test  __rejects the alternate hypothesis__ that the two groups do not share the same mean displaying a very significant `p-value = 0.4466`.

###### Conclusion
We conclude that the two groups do not have significantly different means.



------------


##### d. What is the probability to detect a difference of 1 sd (one standard deviation) 
```{r}
sd(calciumC$CALCIUM)
```

A difference of 1 sd is given by a distance of 3.292922 units from the mean.

*i)* with only 10 animals per group?
As we only have two groups, namely: `control` and `MON810` with only 10 animals per group we have `df = 10*2-2`
```{r}
pt(q = -sd(calciumC$CALCIUM), df = 10*2-2)
```

The proability of observing 1 standard deviation from the mean with 10 animals per group is `0.20%`.

*ii)* with 20 animals? 
As we only have two groups, namely: `control` and `MON810` with only 20 animals per group we have `df = 20*2-2`
```{r}
pt(q = -sd(calciumC$CALCIUM), df = 20*2-2)
```

The proability of observing 1 standard deviation from the mean with 10 animals per group is `0.11%`.

*iii)* How can we ensure to detect such difference with a probability of 80%?
```{r}
lower = qt(p = 0.025, df = dim(calciumC)[1]-2)
lower
upper = qt(p = 0.975, df = dim(calciumC)[1]-2)

pt(q = lower, df = dim(calciumC)[1]-2)
```
  
  
  
--------------  
  
##### e. Test for the males if the mean levels of calcium for period 2 of the `control` and `MON810` groups* are equivalent. The equivalence limits will be defined using the 6 reference groups as 
```{r}
# Filter the relevant data
calciumE <- data %>% filter(sex == 'M', period == 2, regimen != 'control', regimen != 'MON810') %>% select(regimen, CALCIUM) %>% na.omit
calciumE$regimen <- as.factor(calciumE$regimen)

# Calculate the mean of each regiem
calciumEMean <- aggregate(calciumE$CALCIUM  ~ calciumE$regimen, FUN = 'mean')
colnames(calciumEMean) <- c('regimen', 'CALCIUM')
calciumEMean
```

*i)* one standard deviation of the 6 reference means,
```{r}
# The size of our confidence interval is given by a deviation from the mean in either direction of:
sd(calciumEMean$CALCIUM)

# The probability of observing a deviation of this size
pt(q = -sd(calciumEMean$CALCIUM), df = dim(calciumE)[1]-6)*2
```

Our degrees of freedom is given by the number of observations minus the number of separate sets we calculated the mean from: `df = 58 - 6 = 52`
The result shows that we have a probability of `42.30%` of observing one standard deviation of the 6 reference means given all observations.

*ii)* two standard deviations of the 6 reference means.
```{r}
# The probability of observing a deviation of twice this size
pt(q = -2*sd(calciumEMean$CALCIUM), df = dim(calciumE)[1]-6)*2
```

Similarly, the probability of observing two standard deviations from the mean given our data is `11.75%` with `df = 52`
   
##### f. Summarize and comment these results.
```{r}

```















#### __(Q2)__ Do the same analysis with the variable "DIRBILI" (direct bilirubin)

We consider the variable "DIRBILI".
###### a. Test if the mean level of DIRBILI for period 2 is the same for males and females.
```{r}
# Filter the data was want and remove NA from variable
dirbiliA <- data %>% filter(period == 2) %>% select(DIRBILI, sex) %>% na.omit

# Calculate the sample means
dirbiliAMean <- aggregate(dirbiliA$DIRBILI  ~ dirbiliA$sex, FUN = 'mean')
colnames(dirbiliAMean) <- c('sex', 'DIRBILI')

# Plot the data
ggplot() + 
  geom_point(data = dirbiliA, aes(x = DIRBILI, y = sex, colour = sex, alpha = 0.5), show.legend = FALSE) +
  geom_point(data = dirbiliAMean, aes(x = DIRBILI, y = sex, color = sex, size = 4, alpha = 0.5), show.legend = FALSE)
```

This data seems to be discrete, having a value of 0.100 or 0.001.
```{r}
summary(dirbiliA)
```

```{r}
# Let's take a look at the means by sex
dirbiliAMean
```



# Multiple comparisons
#### __(Q1)__
Redo the three tests of the previous section (questions a., b. and c.) for now comparing  the means of all the quantitative variables (see the annex 5 of the ANSES report <ttt>BIOT2009sa0285Ra.pdf</ttt> to know the type of each variable). Store the results (i.e. all the p-values) in a dataframe with one variable per row and four columns (name of the variable + three p-values). 

#### __(Q2)__
For each of the three tests, adjust the p-values using the Bonferroni  and the Benjamini-Hochberg corrections. How can we interpret these results?




























